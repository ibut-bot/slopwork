generator client {
  provider        = "prisma-client"
  output          = "../app/generated/prisma"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["slopwork"]
}

// --- Enums ---

enum TaskStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  DISPUTED
  CANCELLED

  @@schema("slopwork")
}

enum BidStatus {
  PENDING
  ACCEPTED
  REJECTED
  FUNDED
  PAYMENT_REQUESTED
  COMPLETED
  DISPUTED

  @@schema("slopwork")
}

enum DisputeStatus {
  PENDING
  ACCEPTED
  DENIED

  @@schema("slopwork")
}

enum DisputeRaisedBy {
  CREATOR
  BIDDER

  @@schema("slopwork")
}

// --- Models ---

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  username      String?  @unique
  profilePicUrl String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tasks             Task[]    @relation("TaskCreator")
  bids              Bid[]     @relation("Bidder")
  sentMessages      Message[] @relation("MessageSender")
  receivedMessages  Message[] @relation("MessageRecipient")
  @@index([walletAddress])
  @@index([username])
  @@schema("slopwork")
}

model AuthNonce {
  id            String   @id @default(uuid())
  walletAddress String
  nonce         String   @unique
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  @@index([walletAddress])
  @@index([expiresAt])
  @@schema("slopwork")
}

model Task {
  id                  String     @id @default(uuid())
  creatorId           String
  title               String
  description         String
  budgetLamports      BigInt
  status              TaskStatus @default(OPEN)
  paymentTxSignature  String     @unique
  winningBidId        String?    @unique
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  creator             User       @relation("TaskCreator", fields: [creatorId], references: [id])
  winningBid          Bid?       @relation("WinningBid", fields: [winningBidId], references: [id])
  bids                Bid[]      @relation("TaskBids")
  messages            Message[]

  @@index([creatorId])
  @@index([status])
  @@index([createdAt])
  @@schema("slopwork")
}

model Bid {
  id               String    @id @default(uuid())
  taskId           String
  bidderId         String
  amountLamports   BigInt
  description      String
  multisigAddress  String?
  vaultAddress     String?
  fundingTxSig     String?
  proposalIndex    Int?
  paymentTxSig     String?
  status           BidStatus @default(PENDING)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  task             Task      @relation("TaskBids", fields: [taskId], references: [id])
  bidder           User      @relation("Bidder", fields: [bidderId], references: [id])
  wonTask          Task?     @relation("WinningBid")
  disputes         Dispute[]

  @@unique([fundingTxSig])
  @@index([taskId])
  @@index([bidderId])
  @@index([status])
  @@schema("slopwork")
}

model Message {
  id          String   @id @default(uuid())
  taskId      String
  senderId    String
  recipientId String?  // The other party in the private conversation. Null for legacy public messages.
  content     String
  attachments Json?    // Array of { url, key, contentType, size, filename }
  createdAt   DateTime @default(now())

  task        Task     @relation(fields: [taskId], references: [id])
  sender      User     @relation("MessageSender", fields: [senderId], references: [id])
  recipient   User?    @relation("MessageRecipient", fields: [recipientId], references: [id])

  @@index([taskId, createdAt])
  @@index([senderId])
  @@index([recipientId])
  @@index([taskId, senderId, recipientId])
  @@schema("slopwork")
}

model Dispute {
  id               String          @id @default(uuid())
  bidId            String
  raisedBy         DisputeRaisedBy
  raisedByWallet   String
  proposalIndex    Int             // On-chain proposal index for this dispute
  proposalTxSig    String          // Tx signature of the proposal creation
  reason           String
  evidenceUrls     String[]        @default([])
  status           DisputeStatus   @default(PENDING)
  responseReason   String?         // Respondent's counter-argument
  responseEvidence String[]        @default([])
  resolutionNotes  String?
  resolvedByWallet String?
  resolveTxSig     String?         // If accepted: the arbiter's approve tx signature
  executeTxSig     String?         // If accepted: the execute tx signature
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  resolvedAt       DateTime?

  bid              Bid             @relation(fields: [bidId], references: [id])

  @@index([bidId])
  @@index([status])
  @@index([createdAt])
  @@schema("slopwork")
}
